<% layout('layouts/boilerplate') %>

<div class="container mt-4 mb-5">
  <div class="row">
    <div class="col-lg-8 offset-lg-2">
      <div class="d-flex align-items-center mb-4">
        <div class="brand-icon-box me-3 bg-info-subtle">
          <i class="bi bi-pencil-square fs-3 text-info"></i>
        </div>
        <div>
          <h1 class="display-6 fw-bold m-0">Edit Product</h1>
          <p class="text-muted m-0">Modify details for <span class="text-dark fw-semibold"><%= product.title %></span></p>
        </div>
      </div>

      <div class="admin-card p-4 p-md-5">
        <form action="/products/<%= product._id %>?_method=PUT" method="POST" enctype="multipart/form-data" class="validated-form" novalidate>
          
          <div class="row g-4">
            <div class="col-12">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="title" name="product[title]" placeholder="Product Title" value="<%= product.title %>" required>
                <label for="title">Product Title</label>
              </div>
            </div>

            <div class="col-12">
              <div class="form-floating mb-3">
                <textarea class="form-control" id="description" name="product[description]" placeholder="Description" style="height: 120px" required><%= product.description %></textarea>
                <label for="description">Product Description</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="input-group custom-input-group">
                <span class="input-group-text bg-white border-end-0">$</span>
                <div class="form-floating flex-grow-1">
                  <input type="number" class="form-control border-start-0 ps-0" id="price" name="product[price]" step="0.01" min="0" placeholder="0.00" value="<%= product.price %>" required>
                  <label for="price">Price</label>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating mb-3">
                <select class="form-select" id="category" name="product[category]" required>
                  <% const categories = ["electronics", "fashion", "home", "books", "beauty", "sports", "other"] %>
                  <% for(let category of categories) { %>
                    <option value="<%=category%>" <%= product.category === category ? 'selected' : '' %>><%= category.charAt(0).toUpperCase() + category.slice(1) %></option>
                  <% } %>
                </select>
                <label for="category">Category</label>
              </div>
            </div>

            <div class="col-12">
              <div class="upload-zone p-4 text-center">
                <i class="bi bi-cloud-arrow-up fs-2 text-muted mb-2 d-block"></i>
                <label for="image" class="form-label fw-bold">Add More Images</label>
                <input class="form-control mt-2" type="file" id="image" name="image" multiple>
                <small class="text-muted mt-2 d-block">Hold Ctrl/Cmd to select multiple files</small>
              </div>
            </div>

            <div class="col-12 mt-4">
              <h6 class="fw-bold mb-3 d-flex align-items-center">
                <i class="bi bi-images me-2"></i> Current Assets
              </h6>
              <div class="row row-cols-2 row-cols-md-4 g-3">
                <% product.images.forEach((img, i) => { %>
                <div class="col">
                  <div class="image-manage-card position-relative">
                    <img src="<%= img.url %>" class="img-fluid rounded-3" alt="">
                    <div class="delete-overlay">
                      <div class="form-check m-0">
                        <input class="form-check-input d-none delete-checkbox" type="checkbox" name="deleteImages[]" value="<%= img.filename %>" id="image-<%= i %>">
                        <label class="delete-btn-label" for="image-<%= i %>">
                          <i class="bi bi-trash3-fill"></i>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
                <% }) %>
              </div>
              <p class="extra-small text-muted mt-2 fst-italic">* Click the trash icon to mark an image for removal</p>
            </div>

            <div class="col-12 mt-5">
              <div class="d-flex gap-3">
                <button type="submit" class="btn btn-nova-primary w-100 py-3">
                  Save Changes <i class="bi bi-check2-circle ms-2"></i>
                </button>
                <a href="/products/<%= product._id %>" class="btn btn-nova-outline w-100 py-3">Cancel</a>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  .admin-card {
    background: white;
    border-radius: 24px;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 10px 30px rgba(0,0,0,0.02);
  }

  .form-control:focus, .form-select:focus {
    border-color: var(--brand-primary);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
  }

  .upload-zone {
    border: 2px dashed #e2e8f0;
    border-radius: 16px;
    background: #f8fafc;
    transition: var(--transition);
  }

  .upload-zone:hover {
    border-color: var(--brand-primary);
    background: #f1f5f9;
  }

  /* Image Management Styling */
  .image-manage-card {
    height: 120px;
    overflow: hidden;
    background: #eee;
    border: 1px solid #eee;
  }

  .image-manage-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .delete-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .image-manage-card:hover .delete-overlay {
    opacity: 1;
  }

  .delete-btn-label {
    cursor: pointer;
    width: 35px;
    height: 35px;
    background: #fff;
    color: #ef4444;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
  }

  .delete-checkbox:checked + .delete-btn-label {
    background: #ef4444;
    color: #fff;
    transform: scale(1.1);
  }

  /* When checked, make the image look faded */
  .delete-checkbox:checked ~ img {
    opacity: 0.3;
    filter: grayscale(1);
  }

  .extra-small { font-size: 0.75rem; }
</style>

<script>
    (function () {
        'use strict'
        const forms = document.querySelectorAll('.validated-form')
        Array.from(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()
</script>